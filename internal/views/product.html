{{define "product.html"}}
{{template "layout_start" .}}
<nav class="breadcrumbs" aria-label="Breadcrumb" style="margin-bottom:16px">
  <a href="/">Tienda</a>
  <span style="margin:0 8px;color:var(--color-muted)">‚Ä∫</span>
  <a href="/products?category={{.Product.Category}}">{{.Product.Category}}</a>
  <span style="margin:0 8px;color:var(--color-muted)">‚Ä∫</span>
  <span style="color:var(--color-text)">{{.Product.Name}}</span>
</nav>

<article class="product-detail">
  <div class="pd-media">
    {{if .Product.Images}}
      <div class="pd-carousel" id="pdCarousel" data-count="{{len .Product.Images}}">
        <div class="pd-slides">
          {{range $i,$img := .Product.Images}}
            <img class="pd-slide {{if eq $i 0}}active{{end}}" src="{{img $img.URL}}" alt="{{if $img.Alt}}{{$img.Alt}}{{else}}{{$.Product.Name}}{{end}}" data-index="{{$i}}" loading="{{if eq $i 0}}eager{{else}}lazy{{end}}" />
          {{end}}
        </div>
        <div class="pd-counter" id="pdCounter">{{if gt (len .Product.Images) 1}}1/{{len .Product.Images}} Fotos{{end}}</div>
        <button type="button" class="pd-nav prev" aria-label="Anterior">‚Äπ</button>
        <button type="button" class="pd-nav next" aria-label="Siguiente">‚Ä∫</button>
        {{if gt (len .Product.Images) 1}}
        <div class="pd-thumbs">
          {{range $i,$img := .Product.Images}}
            <button type="button" class="pd-thumb {{if eq $i 0}}active{{end}}" data-index="{{$i}}">
              <img src="{{img $img.URL}}" alt="{{if $img.Alt}}{{$img.Alt}}{{else}}{{$.Product.Name}}{{end}} miniatura" loading="lazy" />
            </button>
          {{end}}
        </div>
        {{end}}
      </div>
    {{else}}
      <div class="pd-carousel empty" data-count="0"><div class="pd-slides placeholder">SIN IMAGEN</div></div>
    {{end}}
  </div>
  
  <div class="pd-info">
    <div class="pd-badges-top">
      <span class="badge green">12x sin inter√©s</span>
      <span class="badge gray">Env√≠o gratis</span>
    </div>
    
    <h1 class="pd-title">{{.Product.Name}}</h1>
    
    <div class="pd-includes" style="margin:8px 0 16px;font-size:14px;color:var(--color-muted)">
      <strong style="color:var(--color-text)">Incluye accesorios</strong>
    </div>
    
    {{if .Colors}}
    <div class="pd-selector-group">
      <label class="pd-selector-label">Color:</label>
      <div class="pd-selector-options">
        {{range $i,$c := .Colors}}
          <button type="button" class="pd-selector-option {{if eq $i 0}}selected{{end}}" data-color="{{$c}}" title="{{$c}}">
            <span class="pd-color-dot" style="background: {{colorhex $c}};"></span>
            <span>{{$c}}</span>
          </button>
        {{end}}
      </div>
    </div>
    {{end}}
    
    <div class="pd-price-section">
      {{$originalPrice := mul .Product.BasePrice 1.3}}
      <div class="pd-price-old">{{ars $originalPrice}}</div>
      <div class="pd-price-discount">31% OFF</div>
      <div class="pd-price-current">{{ars .Product.BasePrice}}</div>
      <div class="pd-price-installment">12x ${{printf "%.0f" (div .Product.BasePrice 12.0)}} sin inter√©s</div>
    </div>
    
    <div class="pd-promotions" style="margin:20px 0;padding:16px;background:#F5F5F5;border-radius:8px">
      <div style="font-weight:600;margin-bottom:12px;font-size:14px">Promociones Financieras</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-weight:600">12 cuotas</span>
          <span style="color:var(--color-muted)">sin inter√©s</span>
        </div>
      </div>
    </div>
    
    <div class="pd-shipping" style="margin:20px 0;padding:16px;background:#F5F5F5;border-radius:8px">
      <h3 style="font-size:16px;font-weight:600;margin:0 0 12px">Calcul√° el costo de env√≠o</h3>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span>üìç</span>
        <div>
          <div style="font-weight:500">Env√≠o a <strong>todo el pa√≠s</strong></div>
          <div style="color:var(--color-success);font-weight:600;font-size:14px">Gratis</div>
        </div>
      </div>
      <div style="margin-top:16px">
        <div style="font-weight:600;margin-bottom:8px;font-size:14px">Tiempos de entrega</div>
        <div style="font-size:13px;color:var(--color-muted);line-height:1.6">
          <div>CABA: Hasta 48 h h√°biles</div>
          <div>GBA: de 2 a 3 d√≠as h√°biles</div>
          <div>Resto del pa√≠s: hasta 4 d√≠as h√°biles</div>
        </div>
      </div>
    </div>
    
    <form method="post" action="/cart" class="pd-form" style="margin-top:24px">
      <input type="hidden" name="slug" value="{{.Product.Slug}}" />
      <input type="hidden" name="color" id="colorInput" value="{{.DefaultColor}}" />
      <div class="pd-actions" style="display:flex;gap:12px">
        <button class="btn-secondary" type="button" onclick="this.form.submit()" style="flex:1;padding:14px;font-size:15px;font-weight:500">Agregar al carrito</button>
        <button class="btn-primary" type="submit" style="flex:1;padding:14px;font-size:15px;font-weight:500">Comprar</button>
      </div>
      <span id="addedMsg" class="added-msg" {{if ne .Added 1}}hidden{{end}} style="display:block;margin-top:12px;color:var(--color-success);font-weight:600;text-align:center">{{if eq .Added 1}}‚úì Agregado al carrito{{end}}</span>
    </form>
  </div>
</article>

<section class="pd-features" style="margin-top:48px">
  <h2 style="font-size:28px;font-weight:700;margin:0 0 24px">Caracter√≠sticas de {{.Product.Name}}</h2>
  
  <div class="pd-tabs" style="display:flex;gap:0;border-bottom:2px solid var(--color-border);margin-bottom:24px">
    <button class="pd-tab active" data-tab="highlights">Destacadas</button>
    <button class="pd-tab" data-tab="specs">Especificaciones</button>
    <button class="pd-tab" data-tab="info">M√°s informaci√≥n</button>
  </div>
  
  <div class="pd-tab-content" id="tab-highlights">
    <div class="pd-features-grid">
      <div class="pd-feature-card">
        <div class="pd-feature-icon">üì±</div>
        <div class="pd-feature-title">Pantalla</div>
        <div class="pd-feature-desc">Pantalla de alta calidad para una experiencia visual superior</div>
      </div>
      <div class="pd-feature-card">
        <div class="pd-feature-icon">üì∑</div>
        <div class="pd-feature-title">C√°mara</div>
        <div class="pd-feature-desc">Sistema de c√°maras avanzado para capturar tus mejores momentos</div>
      </div>
      <div class="pd-feature-card">
        <div class="pd-feature-icon">‚ö°</div>
        <div class="pd-feature-title">Rendimiento</div>
        <div class="pd-feature-desc">Procesador potente para un rendimiento fluido y r√°pido</div>
      </div>
      <div class="pd-feature-card">
        <div class="pd-feature-icon">üîã</div>
        <div class="pd-feature-title">Bater√≠a</div>
        <div class="pd-feature-desc">Bater√≠a de larga duraci√≥n para todo el d√≠a</div>
      </div>
    </div>
  </div>
  
  <div class="pd-tab-content" id="tab-specs" style="display:none">
    <div class="pd-specs-grid">
      <div class="pd-spec-item">
        <div class="pd-spec-label">Marca/Categor√≠a</div>
        <div class="pd-spec-value">{{.Product.Category}}</div>
      </div>
      <div class="pd-spec-item">
        <div class="pd-spec-label">Garant√≠a</div>
        <div class="pd-spec-value">Oficial</div>
      </div>
      <div class="pd-spec-item">
        <div class="pd-spec-label">Incluye</div>
        <div class="pd-spec-value">Cargador, cable, manual de usuario</div>
      </div>
    </div>
  </div>
  
  <div class="pd-tab-content" id="tab-info" style="display:none">
    <div class="pd-info-content" style="line-height:1.6;color:var(--color-text)">
      <p>Garant√≠a oficial y factura. Env√≠o a todo el pa√≠s o retiro en local.</p>
      <p style="margin-top:12px">Para m√°s informaci√≥n, escribinos por <a href="https://wa.me/5493416219815" target="_blank" rel="noopener" style="color:var(--color-brand);text-decoration:underline">WhatsApp</a>.</p>
    </div>
  </div>
</section>

<script>
(function(){
  const inp=document.getElementById('colorInput');
  const defaultColor=inp?inp.value:'';
  const chips=[...document.querySelectorAll('.pd-selector-option')];
  if(chips.length && inp){
    chips.forEach(btn=>btn.addEventListener('click',()=>{
      chips.forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      const col=btn.getAttribute('data-color')||'';
      inp.value=col||defaultColor;
    }));
  }
  
  // Tabs
  const tabs=document.querySelectorAll('.pd-tab');
  const contents=document.querySelectorAll('.pd-tab-content');
  tabs.forEach(tab=>{
    tab.addEventListener('click',()=>{
      const target=tab.getAttribute('data-tab');
      tabs.forEach(t=>t.classList.remove('active'));
      contents.forEach(c=>c.style.display='none');
      tab.classList.add('active');
      const content=document.getElementById('tab-'+target);
      if(content) content.style.display='block';
    });
  });
  
  // Carousel
  const root=document.getElementById('pdCarousel');
  if(root){
    const slides=[...root.querySelectorAll('.pd-slide')];
    const thumbs=[...root.querySelectorAll('.pd-thumb')];
    const counter=document.getElementById('pdCounter');
    const total=slides.length;
    if(total>0){
      let idx=0;
      let auto=null;
      const AUTOPLAY=5000;
      const prevBtn=root.querySelector('.pd-nav.prev');
      const nextBtn=root.querySelector('.pd-nav.next');
      if(total===1){
        if(prevBtn) prevBtn.style.display='none';
        if(nextBtn) nextBtn.style.display='none';
        const tb=root.querySelector('.pd-thumbs');
        if(tb) tb.style.display='none';
        if(counter) counter.style.display='none';
        return;
      }
      function show(n){
        slides[idx].classList.remove('active');
        if(thumbs[idx]) thumbs[idx].classList.remove('active');
        idx=(n+total)%total;
        slides[idx].classList.add('active');
        if(thumbs[idx]) thumbs[idx].classList.add('active');
        if(counter) counter.textContent=(idx+1)+'/'+total+' Fotos';
      }
      function next(){show(idx+1);}
      function prev(){show(idx-1);}
      function start(){auto=setInterval(next,AUTOPLAY);}
      function restart(){clearInterval(auto);start();}
      root.addEventListener('click',(e)=>{
        const t=e.target.closest('.pd-thumb');
        if(t){
          const i=parseInt(t.getAttribute('data-index')||'-1');
          if(!isNaN(i)&&i>=0&&i<total){
            show(i);
            restart();
          }
          return;
        }
        if(e.target.closest('.pd-nav.prev')){
          prev();
          restart();
          return;
        }
        if(e.target.closest('.pd-nav.next')){
          next();
          restart();
          return;
        }
      });
      let startX=0;
      let isSwiping=false;
      root.addEventListener('touchstart',e=>{
        startX=e.touches[0].clientX;
        isSwiping=true;
      },{passive:true});
      root.addEventListener('touchmove',e=>{
        if(!isSwiping)return;
        const currentX=e.touches[0].clientX;
        const deltaX=currentX-startX;
        if(Math.abs(deltaX)>10){
          e.preventDefault();
        }
      },{passive:false});
      root.addEventListener('touchend',e=>{
        if(!isSwiping)return;
        isSwiping=false;
        const endX=e.changedTouches[0].clientX;
        const deltaX=endX-startX;
        if(Math.abs(deltaX)>50){
          if(deltaX>0){
            prev();
          }else{
            next();
          }
          restart();
        }
      },{passive:true});
      let sx=null;
      root.addEventListener('pointerdown',e=>{sx=e.clientX;});
      root.addEventListener('pointerup',e=>{
        if(sx==null)return;
        const dx=e.clientX-sx;
        if(Math.abs(dx)>40){
          dx<0?next():prev();
          restart();
        }
        sx=null;
      });
      root.addEventListener('keydown',e=>{
        if(e.key==='ArrowRight'){
          next();
          restart();
        }else if(e.key==='ArrowLeft'){
          prev();
          restart();
        }
      });
      root.tabIndex=0;
      start();
    }
  }
  
  // Form submit
  const form=document.querySelector('.pd-form');
  if(form){
    const addedMsg=document.getElementById('addedMsg');
    form.addEventListener('submit',function(e){
      e.preventDefault();
      const submitBtn=form.querySelector('button[type=submit]');
      if(submitBtn) submitBtn.disabled=true;
      const fd=new FormData(form);
      try{
        const cur=(inp&&typeof inp.value==='string')?inp.value.trim():'';
        const finalCol=cur||defaultColor||'';
        if(fd.has('color')) fd.set('color',finalCol);
        else fd.append('color',finalCol);
      }catch{}
      const usp=new URLSearchParams();
      fd.forEach((v,k)=>{if(typeof v==='string') usp.append(k,v);});
      fetch('/cart',{
        method:'POST',
        headers:{
          'Accept':'application/json',
          'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8',
          'X-Requested-With':'fetch'
        },
        body:usp.toString(),
        redirect:'manual'
      }).then(async res=>{
        if(res.ok){
          let itemsCount=null;
          try{
            const j=await res.json();
            itemsCount=j.items;
          }catch{}
          if(addedMsg){
            addedMsg.hidden=false;
            addedMsg.textContent='‚úì Agregado'+(itemsCount!=null?' (total '+itemsCount+')':'')+'!';
            addedMsg.style.display='block';
            setTimeout(()=>{
              addedMsg.style.opacity='0';
              setTimeout(()=>{addedMsg.hidden=true;addedMsg.style.opacity='1';},300);
            },2500);
          }
        }else if(res.status===302){
          if(addedMsg){
            addedMsg.hidden=false;
            addedMsg.textContent='‚úì Agregado!';
            addedMsg.style.display='block';
            setTimeout(()=>{
              addedMsg.style.opacity='0';
              setTimeout(()=>{addedMsg.hidden=true;addedMsg.style.opacity='1';},300);
            },2500);
          }
        }else{
          throw new Error('status '+res.status);
        }
      }).catch(()=>{
        if(addedMsg){
          addedMsg.hidden=false;
          addedMsg.textContent='‚úó Error';
          addedMsg.style.color='var(--color-danger)';
          addedMsg.style.display='block';
        }
      }).finally(()=>{
        if(submitBtn) submitBtn.disabled=false;
      });
    });
  }
})();
</script>
{{template "layout_end" .}}
{{end}}
