{{define "admin_products.html"}}
{{template "layout_start" .}}
<h1>Productos</h1>
<nav class="admin-nav"><a href="/admin/products" class="active">Productos</a> | <a href="/admin/featured">Destacados</a> | <a href="/admin/orders">√ìrdenes</a> | <a href="/admin/sales">Ventas</a> | <a href="/admin/uncharged">Sin precio</a> | <a href="/admin/logout">Salir</a></nav>
<section class="grid" style="margin-top:1rem;grid-template-columns:420px minmax(0,1fr);gap:2rem;align-items:start">
  <div class="admin-card" style="padding:18px 20px 24px">
    <div class="row between center" style="margin-bottom:12px;flex-wrap:wrap;gap:8px">
      <h2 style="margin:0;font-size:18px">Gesti√≥n de producto</h2>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <span id="formMode" class="mode-badge create" style="font-size:14px;padding:6px 14px;font-weight:600;border-radius:6px">‚ú® Creaci√≥n</span>
        <span id="editingProduct" style="font-size:11px;color:var(--muted);max-width:200px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:none"></span>
      </div>
    </div>
    <form id="prodForm" class="form-card" autocomplete="off">
      <input type="hidden" name="slug" id="pfSlug" />
      <label>Nombre<input type="text" name="name" id="pfName" required placeholder="Nombre visible" /></label>
      <label>Categor√≠a<input type="text" name="category" id="pfCategory" placeholder="(opcional)" /></label>
      <div class="row" style="gap:.5rem">
        <label style="flex:1">Marca<input type="text" name="brand" id="pfBrand" placeholder="(opcional)" /></label>
        <label style="flex:1">Modelo<input type="text" name="model" id="pfModel" placeholder="(opcional)" /></label>
      </div>
      <label>Descripci√≥n corta<textarea name="short_desc" id="pfShort" placeholder="Resumen / marketing"></textarea></label>
      <div class="row" style="gap:.5rem">
        <label style="flex:1">Precio bruto<input type="number" step="0.01" min="0" id="pfGross" placeholder="0.00" /></label>
        <label style="flex:1">Margen (%)<input type="number" step="0.01" min="0" id="pfMargin" placeholder="0" /></label>
      </div>
      <div class="row" style="gap:.5rem">
        <label style="flex:1">Ancho (mm)<input type="number" step="0.1" min="0" id="pfWidth" placeholder="0" /></label>
        <label style="flex:1">Alto (mm)<input type="number" step="0.1" min="0" id="pfHeight" placeholder="0" /></label>
        <label style="flex:1">Profundidad (mm)<input type="number" step="0.1" min="0" id="pfDepth" placeholder="0" /></label>
      </div>
      <label>Precio venta<input type="number" step="0.01" min="0" name="base_price" id="pfPrice" required placeholder="0.00" /></label>
      <small id="pfGainInfo" style="display:block;margin:-6px 0 8px;color:var(--muted)">Ganancia estimada: $0.00</small>
      <label class="row center" style="gap:.5rem"><input type="checkbox" name="ready_to_ship" id="pfReady" checked /> Listo para env√≠o</label>
      <label>Atributos (JSON opcional)<textarea name="attributes" id="pfAttrs" placeholder='{"color":"Negro","capacidad":"128GB"}'></textarea></label>
      <!-- Galer√≠a de im√°genes actuales (solo visible al editar) -->
      <div id="currentImagesBlock" style="display:none;margin-bottom:12px">
        <label style="display:block;font-size:12px;font-weight:600;letter-spacing:.6px;color:var(--muted);text-transform:uppercase;margin-bottom:8px">üñºÔ∏è Im√°genes actuales</label>
        <div id="currentImagesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-bottom:8px"></div>
      </div>
      
      <div class="uploader-block">
        <label style="display:flex;flex-direction:column;gap:6px;font-size:12px;font-weight:600;letter-spacing:.6px;color:var(--muted);text-transform:uppercase">
          <span id="imagesLabel">üì§ Nuevas im√°genes (opcional)</span>
          <div id="dropZone" class="dropzone" style="padding:24px;min-height:120px;border:2px dashed var(--color-border);border-radius:8px;background:var(--panel-alt);transition:all .2s;cursor:pointer">
            <input type="file" multiple accept="image/*" id="pfImages" style="display:none" />
            <div style="text-align:center">
              <div style="font-size:32px;margin-bottom:8px">üìÅ</div>
              <span class="dz-hint" style="display:block;font-size:14px;color:var(--color-text);margin-bottom:4px">Arrastr√° im√°genes aqu√≠ o hac√© click para seleccionar</span>
              <small class="dz-count" style="display:block;color:var(--muted);font-size:12px">0 archivos seleccionados</small>
            </div>
            <div id="preview" class="dz-preview" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;justify-content:center"></div>
          </div>
        </label>
      </div>
      <div class="inline-btns" style="margin-top:4px">
        <button class="btn-primary" type="submit" id="pfSubmit">Crear</button>
        <button class="btn-secondary" type="button" id="pfReset">Nuevo</button>
        <button class="btn-danger" type="button" id="pfDelete" style="display:none">Eliminar</button>
      </div>
    </form>
    <p style="margin:14px 0 0;font-size:11px;color:var(--muted);line-height:1.4">Flujo: completar datos y (opcional) elegir im√°genes. Al guardar, si es creaci√≥n primero se crea el producto y luego se suben las im√°genes seleccionadas. En edici√≥n pod√©s cambiar datos y agregar nuevas im√°genes (no reemplaza las existentes). Para remover im√°genes viejas usar futura gesti√≥n de galer√≠a.</p>
  </div>
  <div>
    <h2 style="margin:0 0 10px;font-size:18px">Listado ({{.Total}})</h2>
    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="text" id="prodSearch" placeholder="Buscar productos por nombre, slug, marca o modelo..." aria-label="Buscar productos" style="flex:1;min-width:200px;max-width:500px;background:#FFFFFF;border:1px solid var(--color-border);color:var(--color-text);font:inherit;padding:11px 14px;border-radius:14px;font-size:14px;line-height:1.3;transition:border-color .18s,background .18s,box-shadow .18s" />
      <button type="button" id="filterNoImages" class="btn-secondary" style="white-space:nowrap;padding:11px 16px;font-size:14px;font-weight:500;border-radius:14px;cursor:pointer;transition:all .18s;background:var(--panel);border:1px solid var(--color-border);color:var(--color-text)">
        üñºÔ∏è Sin im√°genes
      </button>
    </div>
    <div style="overflow-x:auto;overflow-y:visible;max-width:100%">
      <div class="import-section" style="background:var(--panel-alt);padding:16px;border-radius:8px;margin-bottom:12px">
        <h3 style="margin:0 0 12px;font-size:15px;font-weight:600">üì¶ Importaci√≥n masiva</h3>
        
        <div class="import-grid" style="display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:start">
          <!-- Columna 1: Archivo XLSX -->
          <div style="display:flex;flex-direction:column;gap:6px">
            <label class="btn-secondary" for="bulkXlsx" style="cursor:pointer;text-align:center;margin:0">
              <span id="xlsxLabel">üìÑ Seleccionar XLSX</span>
            </label>
            <input type="file" id="bulkXlsx" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx" style="display:none" />
            <small id="xlsxFileName" style="color:var(--muted);font-size:11px;min-height:16px;text-align:center"></small>
          </div>
          
          <!-- Columna 2: Archivo de precios -->
          <div style="display:flex;flex-direction:column;gap:6px">
            <label class="btn-secondary" for="bulkPrices" style="cursor:pointer;text-align:center;margin:0">
              <span id="pricesLabel">üíµ Seleccionar Precios (.txt)</span>
            </label>
            <input type="file" id="bulkPrices" accept=".txt,text/plain" style="display:none" />
            <small id="pricesFileName" style="color:var(--muted);font-size:11px;min-height:16px;text-align:center"></small>
          </div>
          
          <!-- Columna 3: Bot√≥n Importar -->
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn-primary" type="button" id="bulkRun" style="min-width:140px;height:44px;font-size:15px;font-weight:600">
              ‚¨ÜÔ∏è Importar
            </button>
            <small style="color:var(--muted);font-size:11px;text-align:center;min-height:16px;visibility:hidden">-</small>
          </div>
        </div>
        
        <!-- Par√°metros en fila debajo -->
        <div class="import-params" style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:12px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <label style="margin:0">
            <span style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--muted)">üí± TC USD‚ÜíARS</span>
            <input type="number" id="bulkFx" step="0.01" min="0" placeholder="Ej: 1100" style="width:100%" />
          </label>
          <label style="margin:0">
            <span style="display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:var(--muted)">üìà Margen %</span>
            <input type="number" id="bulkMargin" step="0.01" min="0" placeholder="Ej: 20" style="width:100%" />
          </label>
          <div style="display:flex;flex-direction:column;gap:4px;justify-content:center">
            <label class="row center" style="gap:.5rem;margin:0">
              <input type="checkbox" id="bulkUseOpenAI" />
              <span style="font-size:12px">ü§ñ OpenAI (experimental, lento)</span>
            </label>
            <small style="color:var(--muted);font-size:10px">Por defecto: m√©todo tradicional (instant√°neo, 90%+ match)</small>
          </div>
        </div>
      </div>
      <table class="table" id="prodTable" style="font-size:0.8rem;width:100%;table-layout:fixed">
        <colgroup>
          <col style="width:15%">
          <col style="width:12%">
          <col style="width:8%">
          <col style="width:10%">
          <col style="width:7%">
          <col style="width:6%">
          <col style="width:8%">
          <col style="width:8%">
          <col style="width:4%">
          <col style="width:4%">
          <col style="width:18%">
        </colgroup>
        <thead><tr><th>Nombre</th><th>Slug</th><th>Marca</th><th>Modelo</th><th>Bruto</th><th>Margen</th><th>Precio</th><th>Ganancia</th><th>Listo</th><th>Imgs</th><th style="text-align:right;white-space:nowrap">Acciones</th></tr></thead>
        <tbody>
          {{range .Products}}
          <tr data-slug="{{.Slug}}">
            <td>{{.Name}}</td>
            <td style="font-family:monospace">{{.Slug}}</td>
            <td>{{.Brand}}</td>
            <td>{{.Model}}</td>
            <td>${{printf "%.2f" .GrossPrice}}</td>
            <td>{{printf "%.0f" .MarginPct}}%</td>
            <td>${{printf "%.2f" .BasePrice}}</td>
            <td>${{printf "%.2f" (gain .GrossPrice .MarginPct)}}</td>
            <td>{{if .ReadyToShip}}‚úî{{else}}-{{end}}</td>
            <td>{{len .Images}}</td>
            <td style="text-align:right">
              <div class="table-actions">
                <button class="icon-btn action-workflow" data-act="workflow" title="Buscar im√°genes autom√°ticamente">üñºÔ∏è</button>
                <button class="icon-btn action-edit" data-act="edit" title="Editar producto">‚úèÔ∏è</button>
                <button class="icon-btn action-specs" data-act="specs" title="Buscar especificaciones">üìã</button>
                <button class="icon-btn danger action-del" data-act="del" title="Eliminar producto">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal de b√∫squeda de im√°genes -->
<div id="imageSearchModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width:600px">
    <div class="modal-header">
      <h3 style="margin:0;font-size:18px">Agregar imagen desde URL</h3>
      <button id="closeModal" class="btn-close" style="background:none;border:none;font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">&times;</button>
    </div>
    <div class="modal-body" style="padding:24px">
      <p style="margin:0 0 16px;color:var(--muted);font-size:14px">
        Producto: <strong id="modalProductName"></strong>
      </p>
      <div style="background:#f8f9fa;padding:16px;border-radius:6px;margin-bottom:20px">
        <p style="margin:0 0 12px;font-size:14px;font-weight:600">üìù Instrucciones:</p>
        <ol style="margin:0;padding-left:20px;font-size:13px;line-height:1.6">
          <li>Hac√© click en "Buscar en Google" para ver im√°genes del producto</li>
          <li>Click derecho en la imagen que te guste ‚Üí "Copiar direcci√≥n de imagen"</li>
          <li>Peg√° la URL aqu√≠ abajo y hac√© click en "Agregar imagen"</li>
        </ol>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button id="openGoogleBtn" class="btn-primary" style="flex:1">
          üîç Buscar en Google
        </button>
      </div>
      <label style="display:block;margin-bottom:16px">
        <span style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--muted)">URL de la imagen:</span>
        <input type="url" id="imageUrlInput" placeholder="https://ejemplo.com/imagen.jpg" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px" />
      </label>
      <div style="display:flex;gap:8px">
        <button id="addImageBtn" class="btn-primary" style="flex:1">
          ‚úì Agregar imagen
        </button>
        <button id="cancelBtn" class="btn-secondary">
          Cancelar
        </button>
      </div>
      <div id="imagePreview" style="margin-top:16px;display:none">
        <p style="font-size:13px;font-weight:600;margin-bottom:8px">Vista previa:</p>
        <img id="previewImg" style="max-width:100%;max-height:300px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1)" />
      </div>
    </div>
  </div>
</div>

<!-- Modal de workflow de im√°genes -->
<div id="workflowModal" class="modal" style="display:none;z-index:999999">
  <div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto;z-index:1000000">
    <div class="modal-header">
      <h3 style="margin:0;font-size:18px">üîÑ Workflow: Buscar y Agregar Im√°genes</h3>
      <button id="closeWorkflowModal" class="btn-close" style="background:none;border:none;font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center">&times;</button>
    </div>
    <div class="modal-body" style="padding:24px">
      <p style="margin:0 0 16px;color:var(--muted);font-size:14px">
        Producto: <strong id="workflowProductName"></strong>
      </p>
      <div id="workflowLoading" style="display:none;text-align:center;padding:40px">
        <div style="font-size:18px;margin-bottom:12px">üîç Buscando im√°genes...</div>
        <div style="color:var(--muted);font-size:14px">Esto puede tardar unos segundos</div>
      </div>
      <div id="workflowResults" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <p style="margin:0;font-size:14px;font-weight:600">Im√°genes encontradas (<span id="workflowImageCount">0</span>):</p>
          <div style="display:flex;gap:8px">
            <button id="workflowSelectAllBtn" class="btn-secondary" style="padding:6px 12px;font-size:12px">Seleccionar todas</button>
            <button id="workflowDeselectAllBtn" class="btn-secondary" style="padding:6px 12px;font-size:12px">Deseleccionar todas</button>
          </div>
        </div>
        <p style="margin:0 0 12px;font-size:13px;color:var(--muted)">
          Seleccionadas: <strong id="workflowSelectedCount">0</strong> de <span id="workflowTotalCount">0</span>
        </p>
        <div id="workflowImageGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:20px"></div>
        <div style="display:flex;gap:8px">
          <button id="workflowAddSelectedBtn" class="btn-primary" style="flex:1">‚úì Agregar im√°genes seleccionadas (<span id="workflowAddCount">0</span>)</button>
          <button id="workflowCancelBtn" class="btn-secondary">Cancelar</button>
        </div>
      </div>
      <div id="workflowError" style="display:none;background:#fee;color:#c33;padding:16px;border-radius:6px;margin-bottom:16px"></div>
    </div>
  </div>
</div>

<style>
#prodSearch:focus {
  outline: none;
  border-color: var(--color-brand);
  background: #FFFFFF;
  box-shadow: 0 0 0 2px rgba(0,118,199,.2);
}

/* Estilos mejorados para el badge de modo */
.mode-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.mode-badge.create {
  background: var(--color-brand);
  color: #fff;
}
.mode-badge.edit {
  background: #FFA726;
  color: #fff;
  animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 2px 4px rgba(255,167,38,0.3); }
  50% { box-shadow: 0 2px 12px rgba(255,167,38,0.6); }
}

/* Estilos para la secci√≥n de importaci√≥n */
.import-section {
  background: color-mix(in srgb, var(--color-brand) 3%, var(--panel-alt));
  border: 1px solid color-mix(in srgb, var(--color-brand) 10%, transparent);
}

/* Estilos para dropzone mejorado */
.dropzone {
  transition: all 0.2s ease;
}
.dropzone:hover {
  border-color: var(--color-brand);
  transform: translateY(-1px);
}

/* Estilos para botones de acci√≥n en tabla */
.table-actions {
  display: flex;
  gap: 4px;
  justify-content: flex-end;
  flex-wrap: wrap;
}
.icon-btn {
  padding: 6px 10px;
  font-size: 16px;
  border: 1px solid var(--color-border);
  background: var(--panel);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.icon-btn:hover {
  background: var(--color-brand);
  color: #fff;
  border-color: var(--color-brand);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,118,199,0.3);
}
.icon-btn.danger:hover {
  background: var(--color-danger);
  border-color: var(--color-danger);
  box-shadow: 0 2px 6px rgba(211,47,47,0.3);
}

.modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0,0,0,0.75) !important;
  z-index: 999999 !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 20px !important;
  box-sizing: border-box !important;
}
.modal.show,
.modal[style*="display: flex"],
.modal[style*="display:flex"] {
  display: flex !important;
}
.modal-content {
  background: #fff !important;
  border-radius: 8px;
  width: 100%;
  max-width: 900px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 1000000;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #ddd;
  background: #fff;
}
.modal-body {
  padding: 24px;
}
</style>

<script>
(function(){
  const token='{{.AdminToken}}';
  const tbl=document.getElementById('prodTable');
  const form=document.getElementById('prodForm');
  const searchInput=document.getElementById('prodSearch');
  const fSlug=document.getElementById('pfSlug');
  const fName=document.getElementById('pfName');
  const fCat=document.getElementById('pfCategory');
  const fBrand=document.getElementById('pfBrand');
  const fModel=document.getElementById('pfModel');
  const fDesc=document.getElementById('pfShort');
  const fPrice=document.getElementById('pfPrice');
  const fGross=document.getElementById('pfGross');
  const fMargin=document.getElementById('pfMargin');
  const fReady=document.getElementById('pfReady');
  const fWidth=document.getElementById('pfWidth');
  const fHeight=document.getElementById('pfHeight');
  const fDepth=document.getElementById('pfDepth');
  const fAttrs=document.getElementById('pfAttrs');
  const btnDel=document.getElementById('pfDelete');
  const btnReset=document.getElementById('pfReset');
  const btnSubmit=document.getElementById('pfSubmit');
  const modeBadge=document.getElementById('formMode');
  const imagesInput=document.getElementById('pfImages');
  const dropZone=document.getElementById('dropZone');
  const preview=document.getElementById('preview');
  const dzCount=document.querySelector('.dz-count');
  const gainInfo=document.getElementById('pfGainInfo');
  const editingProductEl=document.getElementById('editingProduct');
  const currentImagesBlock=document.getElementById('currentImagesBlock');
  const currentImagesGrid=document.getElementById('currentImagesGrid');
  const imagesLabel=document.getElementById('imagesLabel');
  
  let currentProduct = null; // Producto actual en edici√≥n
  let currentImages = []; // Im√°genes actuales del producto
  let autoSaveTimer = null; // Timer para auto-guardado

  function recomputePrice(){
    const gross=parseFloat(fGross.value||'0');
    const margin=parseFloat(fMargin.value||'0');
    if(gross>=0 && margin>=0){
      const sale=gross * (1 + margin/100);
      const gain=gross * (margin/100);
      if(!Number.isNaN(sale)) fPrice.value = sale.toFixed(2);
      if(gainInfo) gainInfo.textContent = 'Ganancia estimada: $'+ (Number.isNaN(gain)?'0.00':gain.toFixed(2));
    }
  }

  function setModeEdit(edit){
    if(edit){
      modeBadge.textContent='‚úèÔ∏è Edici√≥n';
      modeBadge.classList.remove('create');
      modeBadge.classList.add('edit');
      modeBadge.style.background='#FFA726';
      modeBadge.style.color='#fff';
      btnSubmit.textContent='üíæ Actualizar';
      if(editingProductEl && currentProduct){
        editingProductEl.textContent='Editando: ' + currentProduct.Name;
        editingProductEl.style.display='block';
      }
    } else {
      modeBadge.textContent='‚ú® Creaci√≥n';
      modeBadge.classList.remove('edit');
      modeBadge.classList.add('create');
      modeBadge.style.background='var(--color-brand)';
      modeBadge.style.color='#fff';
      btnSubmit.textContent='‚ú® Crear';
      if(editingProductEl){
        editingProductEl.style.display='none';
      }
    }
  }
  
  function showCurrentImages(images){
    if(!currentImagesGrid || !currentImagesBlock) return;
    currentImages = images || [];
    
    if(currentImages.length === 0){
      currentImagesBlock.style.display='none';
      return;
    }
    
    currentImagesBlock.style.display='block';
    currentImagesGrid.innerHTML='';
    
    currentImages.forEach((img, idx) => {
      const wrapper = document.createElement('div');
      wrapper.style.cssText='position:relative;border-radius:6px;overflow:hidden;aspect-ratio:1;border:2px solid var(--border);background:var(--panel-alt)';
      
      const loader = document.createElement('div');
      loader.className = 'img-loader';
      loader.style.cssText='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--muted);background:var(--panel-alt)';
      loader.textContent='‚è≥';
      wrapper.appendChild(loader);
      
      const imgEl = document.createElement('img');
      let imgUrl = img.URL || '';
      if(imgUrl && !imgUrl.startsWith('http') && !imgUrl.startsWith('/')){
        imgUrl = '/' + imgUrl;
      }
      imgEl.src = imgUrl;
      imgEl.alt = img.Alt || 'Imagen';
      imgEl.style.cssText='width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity 0.3s';
      
      imgEl.onload = function(){
        loader.style.display='none';
        this.style.opacity='1';
      };
      
      imgEl.onerror = function(){
        loader.style.display='none';
        this.style.display='none';
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#c33;text-align:center;padding:4px;background:#fee';
        errorDiv.innerHTML='<div><div style="font-size:20px;margin-bottom:4px">‚ùå</div>Error de carga<br><small style="font-size:9px;color:#999">'+imgUrl+'</small></div>';
        wrapper.appendChild(errorDiv);
      };
      
      const deleteBtn = document.createElement('button');
      deleteBtn.type='button';
      deleteBtn.innerHTML='üóëÔ∏è';
      deleteBtn.style.cssText='position:absolute;top:4px;right:4px;background:rgba(211,47,47,0.9);color:#fff;border:none;border-radius:4px;padding:4px 6px;cursor:pointer;font-size:14px;transition:all .2s;z-index:100;box-shadow:0 2px 6px rgba(0,0,0,0.3)';
      deleteBtn.title='Eliminar imagen (funciona incluso si hay error)';
      deleteBtn.onclick=async ()=>{
        if(confirm('‚ö†Ô∏è ¬øEliminar esta imagen AHORA?\n\nEsta acci√≥n es inmediata y no se puede deshacer.')){
          deleteBtn.disabled=true;
          deleteBtn.textContent='‚è≥';
          
          try{
            console.log('üóëÔ∏è Eliminando imagen √≠ndice:', idx, 'de producto:', currentProduct.Slug);
            
            const deleteRes = await fetch('/api/products/' + encodeURIComponent(currentProduct.Slug) + '/delete-image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({ image_index: idx })
            });
            
            const deleteData = await deleteRes.json();
            console.log('Respuesta del servidor:', deleteData);
            
            if(deleteRes.ok){
              console.log('‚úÖ Imagen eliminada exitosamente');
              
              wrapper.style.transition='all 0.3s ease';
              wrapper.style.transform='scale(0)';
              wrapper.style.opacity='0';
              
              setTimeout(() => {
                wrapper.remove();
                currentImages.splice(idx, 1);       
           
                alert('‚úÖ Imagen eliminada exitosamente\n\nLa p√°gina se recargar√° para mostrar los cambios.');
                savePageState(); 
                location.reload();
              }, 300);
            } else {
              console.error('‚ùå Error del servidor:', deleteData);
              alert('‚ùå Error eliminando imagen: ' + (deleteData.message || 'Error desconocido'));
              deleteBtn.disabled=false;
              deleteBtn.textContent='üóëÔ∏è';
            }
          } catch(err){
            console.error('‚ùå Error de red:', err);
            alert('‚ùå Error de red: ' + err.message);
            deleteBtn.disabled=false;
            deleteBtn.textContent='üóëÔ∏è';
          }
        }
      };
      
      wrapper.appendChild(imgEl);
      wrapper.appendChild(deleteBtn);
      currentImagesGrid.appendChild(wrapper);
    });
  }
  
  function fill(p){
    currentProduct = p;
    fSlug.value=p.Slug; fName.value=p.Name; fCat.value=p.Category||''; fBrand.value=p.Brand||''; fModel.value=p.Model||''; fDesc.value=p.ShortDesc||''; fGross.value=(p.GrossPrice||0); fMargin.value=(p.MarginPct||0); fPrice.value=p.BasePrice; fReady.checked=(p.ReadyToShip!==false); fWidth.value=p.WidthMM||0; fHeight.value=p.HeightMM||0; fDepth.value=p.DepthMM||0; fAttrs.value=p.Attributes?JSON.stringify(p.Attributes):''; btnDel.style.display=''; setModeEdit(true); recomputePrice();
    showCurrentImages(p.Images);
    if(imagesLabel) imagesLabel.textContent='üì§ Agregar m√°s im√°genes (opcional)';
    
    // Scroll suave hacia el formulario de edici√≥n
    setTimeout(() => {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Resaltar el formulario brevemente
      form.style.transition = 'all 0.3s ease';
      form.style.transform = 'scale(1.02)';
      form.style.boxShadow = '0 8px 24px rgba(0, 118, 199, 0.3)';
      setTimeout(() => {
        form.style.transform = 'scale(1)';
        form.style.boxShadow = '';
      }, 500);
    }, 100);
  }
  
  function clear(){ 
    currentProduct = null;
    currentImages = [];
    form.reset(); fSlug.value=''; btnDel.style.display='none'; fReady.checked=true; fWidth.value=fHeight.value=fDepth.value=''; fAttrs.value=''; fGross.value=''; fMargin.value=''; if(gainInfo) gainInfo.textContent='Ganancia estimada: $0.00'; imagesInput.value=''; preview.innerHTML=''; dzCount.textContent='0 archivos seleccionados'; setModeEdit(false); 
    if(currentImagesBlock) currentImagesBlock.style.display='none';
    if(imagesLabel) imagesLabel.textContent='üì§ Nuevas im√°genes (opcional)';
  }

  // Row actions
  if(tbl){
    tbl.addEventListener('click', async e=>{
      const btn=e.target.closest('button');
      if(!btn) return;
      const tr=btn.closest('tr');
      if(!tr) return;
      const slug=tr.dataset.slug;
      if(btn.dataset.act==='edit'){
        const res=await fetch('/api/products/'+slug,{headers:{Authorization:'Bearer '+token}}); if(res.ok){ const p=await res.json(); fill(p);} return;
      }
      if(btn.dataset.act==='del'){
        if(!confirm('‚ö†Ô∏è ¬øEliminar producto y todos sus datos?\n\nEsta acci√≥n no se puede deshacer.')) return;
        const prev=btn.textContent; btn.disabled=true; btn.textContent='‚è≥';
        try{
          const res=await fetch('/api/products/'+slug,{method:'DELETE',headers:{Authorization:'Bearer '+token}}); 
          if(res.ok){ 
            alert('‚úÖ Producto eliminado exitosamente');
            savePageState(); // Guardar estado antes de recargar
            location.reload(); 
          } else { 
            alert('‚ùå Error eliminando producto'); 
          }
        } finally { btn.disabled=false; btn.textContent=prev; }
        return;
      }
      if(btn.dataset.act==='specs'){
        searchSpecs(slug);
        return;
      }
      if(btn.dataset.act==='workflow'){
        console.log('Bot√≥n workflow clickeado, slug:', slug);
        try {
          workflowImages(slug);
        } catch(err) {
          console.error('Error en workflowImages:', err);
          alert('Error: ' + err.message);
        }
        return;
      }
    });
  }

  // B√∫squeda de especificaciones t√©cnicas
  async function searchSpecs(slug) {
    try {
      // Obtener producto primero para mostrar nombre
      const prodRes = await fetch('/api/products/' + slug, {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!prodRes.ok) {
        alert('Error obteniendo producto');
        return;
      }
      const product = await prodRes.json();
      
      // Confirmar b√∫squeda
      const proceed = confirm(
        'üîç Buscar especificaciones t√©cnicas para:\n\n' +
        product.Name + '\n\n' +
        'Esto buscar√° en internet las especificaciones t√©cnicas del producto.\n' +
        '¬øContinuar?'
      );
      if (!proceed) return;
      
      // Buscar especificaciones
      const res = await fetch('/api/products/' + encodeURIComponent(slug) + '/search-specs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      
      const data = await res.json();
      
      if (!res.ok || data.status !== 'ok') {
        alert('‚ùå ' + (data.message || 'Error buscando especificaciones'));
        return;
      }
      
      const specs = data.specifications || {};
      const specKeys = Object.keys(specs);
      
      if (specKeys.length === 0) {
        alert('‚ö†Ô∏è No se encontraron especificaciones t√©cnicas');
        return;
      }
      
      // Mostrar preview
      let previewText = 'üìã Especificaciones encontradas:\n\n';
      specKeys.forEach(key => {
        previewText += `‚Ä¢ ${key}: ${specs[key]}\n`;
      });
      previewText += '\n¬øDeseas actualizar el producto con estas especificaciones?';
      
      const confirmUpdate = confirm(previewText);
      if (!confirmUpdate) return;
      
      // Actualizar producto con las especificaciones
      const updateRes = await fetch('/api/products/' + encodeURIComponent(slug), {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          specifications: specs
        })
      });
      
      if (!updateRes.ok) {
        alert('‚ùå Error actualizando especificaciones');
        return;
      }
      
      alert('‚úÖ Especificaciones actualizadas exitosamente');
      savePageState(); // Guardar estado antes de recargar
      location.reload();
      
    } catch (err) {
      alert('‚ùå Error: ' + err.message);
    }
  }

  // B√∫squeda de imagen MEJORADA
  async function searchImageSimple(slug) {
    try {
      // Obtener producto
      const res = await fetch('/api/products/' + slug, {
        headers: { Authorization: 'Bearer ' + token }
      });
      
      if (!res.ok) {
        alert('Error obteniendo producto');
        return;
      }
      
      const product = await res.json();
      
      // Construir query de b√∫squeda
      let brand = (product.Brand || '').trim();
      if (brand.toLowerCase() === 'moto') brand = 'motorola';
      const model = (product.Model || '').trim();
      const query = [brand, model, 'smartphone'].filter(x => x).join(' ') || product.Name;
      
      // Mostrar instrucciones primero
      const proceed = confirm(
        'üîç Buscar imagen para: ' + product.Name + '\n\n' +
        'Se abrir√° Google Im√°genes con la b√∫squeda autom√°tica.\n' +
        'Luego podr√°s pegar la URL de la imagen que elijas.\n\n' +
        '¬øContinuar?'
      );
      
      if (!proceed) return;
      
      // Abrir Google Images en popup
      const popup = window.open(
        'https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(query), 
        'googleImages',
        'width=800,height=600,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
      );
      
      // Enfocar el popup
      if (popup) {
        popup.focus();
      }
      
      // Mostrar instrucciones inmediatamente
      alert(
        'üìã INSTRUCCIONES:\n\n' +
        '1. ‚úÖ Se abri√≥ Google Im√°genes en un popup\n' +
        '2. üîç Busc√° la imagen que quer√©s usar\n' +
        '3. üñ±Ô∏è Click DERECHO en la imagen\n' +
        '4. üìã Seleccion√° "Copiar direcci√≥n de imagen"\n' +
        '5. üìù Volv√© aqu√≠ y hac√© click en "Pegar URL"\n\n' +
        'Producto: ' + product.Name
      );
      
      // Agregar bot√≥n temporal para pegar URL
      addPasteUrlButton(slug, product.Name);
      
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }
  
  function addPasteUrlButton(slug, productName) {
    // Crear bot√≥n temporal
    const button = document.createElement('button');
    button.textContent = 'üìù Pegar URL de imagen';
    button.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      z-index: 999999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    button.onclick = () => {
      const imageUrl = prompt(
        'üìã PEGAR URL DE IMAGEN:\n\n' +
        '1. ‚úÖ Copiaste la URL de la imagen\n' +
        '2. üìù Peg√° la URL aqu√≠ abajo:\n\n' +
        'Producto: ' + productName
      );
      
      if (!imageUrl || !imageUrl.trim()) {
        return; // Usuario cancel√≥
      }
      
      if (!imageUrl.startsWith('http')) {
        alert('‚ùå URL inv√°lida. Debe comenzar con http:// o https://\n\nEjemplo: https://example.com/imagen.jpg');
        return;
      }
      
      // Descargar imagen
      downloadAndAddImage(slug, imageUrl.trim());
      
      // Remover bot√≥n
      button.remove();
    };
    
    document.body.appendChild(button);
    
    // Auto-remover despu√©s de 5 minutos
    setTimeout(() => {
      if (button.parentNode) {
        button.remove();
      }
    }, 300000);
  }
  
  async function downloadAndAddImage(slug, imageUrl) {
    try {
      const res = await fetch('/api/products/' + encodeURIComponent(slug) + '/download-image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ image_url: imageUrl })
      });
      
      const data = await res.json();
      
      if (!res.ok || data.status !== 'ok') {
        throw new Error(data.message || 'Error descargando imagen');
      }
      
      alert('‚úÖ ' + (data.message || 'Imagen agregada exitosamente'));
      savePageState(); // Guardar estado antes de recargar
      location.reload();
    } catch (err) {
      alert('‚ùå Error: ' + err.message);
    }
  }

  // Workflow: buscar y agregar im√°genes autom√°ticamente
  async function workflowImages(slug) {
    console.log('workflowImages llamado con slug:', slug);
    
    if (!slug) {
      alert('Error: slug no v√°lido');
      return;
    }

    const modal = document.getElementById('workflowModal');
    console.log('Modal encontrado:', !!modal);
    if (!modal) {
      alert('Error: No se encontr√≥ el modal de workflow');
      return;
    }

    const loading = document.getElementById('workflowLoading');
    const results = document.getElementById('workflowResults');
    const error = document.getElementById('workflowError');
    const productName = document.getElementById('workflowProductName');
    const imageGrid = document.getElementById('workflowImageGrid');
    const imageCount = document.getElementById('workflowImageCount');
    const cancelBtn = document.getElementById('workflowCancelBtn');
    const closeBtn = document.getElementById('closeWorkflowModal');

    if (!loading || !results || !error || !productName || !imageGrid || !imageCount || !cancelBtn || !closeBtn) {
      alert('Error: Elementos del modal no encontrados');
      return;
    }

    // Obtener producto para mostrar nombre
    try {
      console.log('Obteniendo producto...');
      const prodRes = await fetch('/api/products/' + slug, {
        headers: { Authorization: 'Bearer ' + token }
      });
      console.log('Respuesta producto:', prodRes.status, prodRes.ok);
      if (!prodRes.ok) {
        const errorText = await prodRes.text();
        console.error('Error obteniendo producto:', errorText);
        alert('Error obteniendo producto: ' + prodRes.status);
        return;
      }
      const product = await prodRes.json();
      console.log('Producto obtenido:', product.Name);
      productName.textContent = product.Name;

      // Mostrar modal
      console.log('Mostrando modal...');
      modal.classList.add('show');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      loading.style.display = 'block';
      results.style.display = 'none';
      error.style.display = 'none';
      imageGrid.innerHTML = '';

      // Buscar im√°genes
      console.log('Buscando im√°genes...');
      const searchRes = await fetch('/api/products/' + encodeURIComponent(slug) + '/search-images', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      console.log('Respuesta b√∫squeda im√°genes:', searchRes.status, searchRes.ok);

      const searchData = await searchRes.json();
      console.log('Datos de b√∫squeda:', searchData);
      loading.style.display = 'none';

      if (!searchRes.ok || searchData.status !== 'ok') {
        console.error('Error en b√∫squeda:', searchData);
        error.style.display = 'block';
        error.textContent = '‚ùå ' + (searchData.message || 'Error buscando im√°genes');
        return;
      }

      const images = searchData.images || [];
      if (images.length === 0) {
        error.style.display = 'block';
        error.textContent = '‚ö†Ô∏è No se encontraron im√°genes para este producto';
        return;
      }

      // Mostrar popup de confirmaci√≥n
      alert(`‚úÖ Se encontraron ${images.length} imagen${images.length > 1 ? 'es' : ''} para "${product.Name}"\n\nSe abrir√° un modal para que puedas revisarlas y agregarlas.`);

      // Mostrar resultados
      imageCount.textContent = images.length;
      const totalCountEl = document.getElementById('workflowTotalCount');
      if (totalCountEl) totalCountEl.textContent = images.length;
      imageGrid.innerHTML = '';
      
      // Array para rastrear qu√© im√°genes est√°n seleccionadas
      const selectedImages = new Set();
      
      // Funci√≥n para actualizar el contador de seleccionadas
      const updateSelectedCount = () => {
        const count = selectedImages.size;
        const selectedCountEl = document.getElementById('workflowSelectedCount');
        const addCountEl = document.getElementById('workflowAddCount');
        if (selectedCountEl) selectedCountEl.textContent = count;
        if (addCountEl) addCountEl.textContent = count;
        const addBtn = document.getElementById('workflowAddSelectedBtn');
        if (addBtn) {
          addBtn.disabled = count === 0;
          if (count === 0) {
            addBtn.textContent = '‚úì Agregar im√°genes seleccionadas (0)';
          } else {
            addBtn.textContent = `‚úì Agregar im√°genes seleccionadas (${count})`;
          }
        }
      };
      
      images.forEach((imgUrl, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.cssText = 'position:relative;border:2px solid #ddd;border-radius:8px;overflow:hidden;cursor:pointer;transition:all 0.2s';
        
        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true; // Por defecto todas seleccionadas
        checkbox.style.cssText = 'position:absolute;top:8px;left:8px;width:20px;height:20px;z-index:10;cursor:pointer;accent-color:#007bff';
        checkbox.dataset.imageUrl = imgUrl;
        checkbox.dataset.imageIndex = index;
        
        // Marcar como seleccionada por defecto
        selectedImages.add(imgUrl);
        
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedImages.add(imgUrl);
            imgContainer.style.borderColor = '#007bff';
            imgContainer.style.borderWidth = '3px';
          } else {
            selectedImages.delete(imgUrl);
            imgContainer.style.borderColor = '#ddd';
            imgContainer.style.borderWidth = '2px';
          }
          updateSelectedCount();
        });
        
        imgContainer.onmouseover = () => {
          if (checkbox.checked) {
            imgContainer.style.borderColor = '#0056b3';
          } else {
            imgContainer.style.borderColor = '#007bff';
          }
        };
        imgContainer.onmouseout = () => {
          if (checkbox.checked) {
            imgContainer.style.borderColor = '#007bff';
          } else {
            imgContainer.style.borderColor = '#ddd';
          }
        };
        
        // Click en el contenedor tambi√©n togglea el checkbox
        imgContainer.addEventListener('click', (e) => {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });
        
        const img = document.createElement('img');
        img.src = imgUrl;
        img.style.cssText = 'width:100%;height:150px;object-fit:cover;display:block;pointer-events:none';
        img.onerror = () => {
          imgContainer.style.display = 'none';
          selectedImages.delete(imgUrl);
          updateSelectedCount();
        };
        
        imgContainer.appendChild(checkbox);
        imgContainer.appendChild(img);
        imageGrid.appendChild(imgContainer);
      });
      
      // Inicializar contador
      updateSelectedCount();
      
      // Botones de seleccionar todas/deseleccionar todas
      const selectAllBtn = document.getElementById('workflowSelectAllBtn');
      const deselectAllBtn = document.getElementById('workflowDeselectAllBtn');
      
      if (selectAllBtn) {
        selectAllBtn.onclick = () => {
          imageGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = true;
            selectedImages.add(cb.dataset.imageUrl);
            const container = cb.closest('div');
            if (container) {
              container.style.borderColor = '#007bff';
              container.style.borderWidth = '3px';
            }
          });
          updateSelectedCount();
        };
      }
      
      if (deselectAllBtn) {
        deselectAllBtn.onclick = () => {
          imageGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            selectedImages.delete(cb.dataset.imageUrl);
            const container = cb.closest('div');
            if (container) {
              container.style.borderColor = '#ddd';
              container.style.borderWidth = '2px';
            }
          });
          updateSelectedCount();
        };
      }

      results.style.display = 'block';
      loading.style.display = 'none';
      
      // Asegurar que el modal sea visible
      modal.classList.add('show');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.zIndex = '999999';
      console.log('Modal display despu√©s de mostrar resultados:', window.getComputedStyle(modal).display);
      console.log('Modal visibility:', window.getComputedStyle(modal).visibility);
      console.log('Modal opacity:', window.getComputedStyle(modal).opacity);
      console.log('Modal z-index:', window.getComputedStyle(modal).zIndex);
      console.log('Results display:', window.getComputedStyle(results).display);
      console.log('Modal tiene clase show:', modal.classList.contains('show'));

      // Handler para agregar im√°genes seleccionadas
      let adding = false;
      const addSelectedBtn = document.getElementById('workflowAddSelectedBtn');
      if (addSelectedBtn) {
        addSelectedBtn.onclick = async () => {
          if (adding) return;
          
          // Obtener im√°genes seleccionadas
          const selectedUrls = Array.from(selectedImages);
          if (selectedUrls.length === 0) {
            alert('‚ö†Ô∏è Por favor selecciona al menos una imagen para agregar.');
            return;
          }
          
          adding = true;
          addSelectedBtn.disabled = true;
          addSelectedBtn.textContent = `‚è≥ Agregando ${selectedUrls.length} imagen${selectedUrls.length > 1 ? 'es' : ''}...`;

          let successCount = 0;
          let errorCount = 0;

          for (const imgUrl of selectedUrls) {
            try {
              const res = await fetch('/api/products/' + encodeURIComponent(slug) + '/download-image', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ image_url: imgUrl })
              });

              const data = await res.json();
              if (res.ok && data.status === 'ok') {
                successCount++;
              } else {
                errorCount++;
              }
            } catch (err) {
              console.error('Error agregando imagen:', imgUrl, err);
              errorCount++;
            }
          }

          if (successCount > 0) {
            alert(`‚úÖ Se agregaron ${successCount} imagen${successCount > 1 ? 'es' : ''} exitosamente${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} imagen${errorCount > 1 ? 'es' : ''} fallaron` : ''}\n\nLa p√°gina se recargar√° para mostrar los cambios.`);
            savePageState(); // Guardar estado antes de recargar
            location.reload();
          } else {
            alert('‚ùå Error: No se pudo agregar ninguna imagen. Por favor, intenta nuevamente.');
            addSelectedBtn.disabled = false;
            addSelectedBtn.textContent = `‚úì Agregar im√°genes seleccionadas (${selectedUrls.length})`;
            adding = false;
          }
        };
      }

      // Handler para cancelar
      cancelBtn.onclick = () => {
        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
      };

      // Handler para cerrar
      closeBtn.onclick = () => {
        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
      };

      // Cerrar al hacer click fuera del modal
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
        }
      };

    } catch (err) {
      console.error('Error completo en workflowImages:', err);
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = '‚ùå Error: ' + err.message;
      // Asegurar que el modal sea visible para mostrar el error
      modal.classList.add('show');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
    }
  }

  // Auto-guardado de borradores
  function scheduleDraftSave(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=>{
      saveDraft();
    }, 3000); // Auto-guardar cada 3 segundos de inactividad
  }
  
  function saveDraft(){
    const draft = {
      name: fName.value.trim(),
      category: fCat.value.trim(),
      brand: fBrand.value.trim(),
      model: fModel.value.trim(),
      short_desc: fDesc.value,
      gross_price: fGross.value,
      margin_pct: fMargin.value,
      base_price: fPrice.value,
      ready_to_ship: fReady.checked,
      width_mm: fWidth.value,
      height_mm: fHeight.value,
      depth_mm: fDepth.value,
      attributes: fAttrs.value,
      timestamp: Date.now()
    };
    localStorage.setItem('productDraft', JSON.stringify(draft));
    console.log('üíæ Borrador guardado autom√°ticamente');
  }
  
  function loadDraft(){
    const draftStr = localStorage.getItem('productDraft');
    if(!draftStr) return false;
    try{
      const draft = JSON.parse(draftStr);
      // Si el borrador tiene menos de 1 hora, restaurarlo
      if(Date.now() - draft.timestamp < 3600000){
        if(confirm('üìã Se encontr√≥ un borrador guardado. ¬øDeseas restaurarlo?')){
          if(fName) fName.value = draft.name || '';
          if(fCat) fCat.value = draft.category || '';
          if(fBrand) fBrand.value = draft.brand || '';
          if(fModel) fModel.value = draft.model || '';
          if(fDesc) fDesc.value = draft.short_desc || '';
          if(fGross) fGross.value = draft.gross_price || '';
          if(fMargin) fMargin.value = draft.margin_pct || '';
          if(fPrice) fPrice.value = draft.base_price || '';
          if(fReady) fReady.checked = draft.ready_to_ship !== false;
          if(fWidth) fWidth.value = draft.width_mm || '';
          if(fHeight) fHeight.value = draft.height_mm || '';
          if(fDepth) fDepth.value = draft.depth_mm || '';
          if(fAttrs) fAttrs.value = draft.attributes || '';
          recomputePrice();
          return true;
        }
      }
      localStorage.removeItem('productDraft');
    }catch(e){
      localStorage.removeItem('productDraft');
    }
    return false;
  }
  
  // Detectar cambios en el formulario para auto-guardar
  [fName, fCat, fBrand, fModel, fDesc, fGross, fMargin, fPrice, fAttrs, fWidth, fHeight, fDepth].forEach(el => {
    if(el){
      el.addEventListener('input', scheduleDraftSave);
    }
  });
  if(fReady) fReady.addEventListener('change', scheduleDraftSave);
  
  // Intentar cargar borrador al inicio
  setTimeout(()=>{ loadDraft(); }, 500);

  // Submit create/update + optional images
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    
    // Deshabilitar bot√≥n de submit durante el proceso
    const origText = btnSubmit.textContent;
    btnSubmit.disabled = true;
    btnSubmit.textContent = '‚è≥ Guardando...';
    
    const slug=fSlug.value.trim();
    let attrs=null; try{ attrs=fAttrs.value.trim()?JSON.parse(fAttrs.value):null; }catch{ alert('‚ùå Atributos JSON inv√°lido'); btnSubmit.disabled=false; btnSubmit.textContent=origText; return; }
    const payload={ name:fName.value.trim(), category:fCat.value.trim(), brand:fBrand.value.trim(), model:fModel.value.trim(), short_desc:fDesc.value, gross_price:parseFloat(fGross.value||'0'), margin_pct:parseFloat(fMargin.value||'0'), base_price:parseFloat(fPrice.value||'0'), ready_to_ship:fReady.checked, width_mm:parseFloat(fWidth.value||'0'), height_mm:parseFloat(fHeight.value||'0'), depth_mm:parseFloat(fDepth.value||'0'), attributes:attrs };
    if(!payload.name){ alert('‚ùå Nombre requerido'); btnSubmit.disabled=false; btnSubmit.textContent=origText; return; }
    if(payload.base_price<0){ alert('‚ùå Precio inv√°lido'); btnSubmit.disabled=false; btnSubmit.textContent=origText; return; }
    
    try{
      // Actualizar datos del producto
      btnSubmit.textContent = '‚è≥ Guardando...';
      let method='POST', url='/api/products';
      if(slug){ method='PUT'; url='/api/products/'+slug; }
      
      const res=await fetch(url,{method, headers:{'Content-Type':'application/json', Authorization:'Bearer '+token}, body:JSON.stringify(payload)});
      if(!res.ok){ 
        alert('‚ùå Error guardando producto'); 
        btnSubmit.disabled=false; 
        btnSubmit.textContent=origText; 
        return; 
      }
      const prod=await res.json();
      const finalSlug=prod.Slug || slug;
      
      // Images?
      if(imagesInput.files && imagesInput.files.length>0){
        btnSubmit.textContent = 'üì§ Subiendo im√°genes...';
        const fd=new FormData();
        fd.append('existing_slug', finalSlug);
        fd.append('brand', fBrand.value.trim());
        fd.append('model', fModel.value.trim());
        if(attrs){ fd.append('attributes', JSON.stringify(attrs)); }
        for(const f of imagesInput.files){ fd.append('images', f); }
        const upRes=await fetch('/api/products/upload',{method:'POST', headers:{Authorization:'Bearer '+token}, body:fd});
        if(!upRes.ok){ 
          alert('‚ö†Ô∏è Producto guardado, pero error subiendo im√°genes\n\nEl producto se guard√≥ correctamente pero las im√°genes no se pudieron subir.'); 
          localStorage.removeItem('productDraft');
          savePageState(); // Guardar estado antes de recargar
          location.reload(); 
          return; 
        }
      }
      
      // √âxito: mostrar mensaje y recargar
      localStorage.removeItem('productDraft'); // Limpiar borrador
      const successMsg = slug ? 
        '‚úÖ Producto actualizado exitosamente!\n\n' + payload.name :
        '‚úÖ Producto creado exitosamente!\n\n' + payload.name;
      
      // Preservar logs en consola antes de recargar
      console.log('%c‚úÖ OPERACI√ìN COMPLETADA EXITOSAMENTE', 'background: #4CAF50; color: white; padding: 4px 8px; font-weight: bold; border-radius: 4px;');
      console.log('üìù Producto:', payload.name);
      console.log('üîÑ Recargando p√°gina en 1 segundo...');
      
      alert(successMsg + '\n\nLa p√°gina se recargar√° para mostrar los cambios.');
      
      savePageState(); // Guardar estado antes de recargar
      setTimeout(() => {
        location.reload();
      }, 100);
      
    }catch(err){
      alert('‚ùå Error de red: ' + err.message);
      btnSubmit.disabled=false;
      btnSubmit.textContent=origText;
    }
  });
  // Carga masiva CSV
  const bulkXlsx=document.getElementById('bulkXlsx');
  const bulkRun=document.getElementById('bulkRun');
  const bulkPrices=document.getElementById('bulkPrices');
  const pricesFileName=document.getElementById('pricesFileName');
  const xlsxFileName=document.getElementById('xlsxFileName');
  const xlsxLabel=document.getElementById('xlsxLabel');
  const pricesLabel=document.getElementById('pricesLabel');
  const bulkFx=document.getElementById('bulkFx');
  const bulkMargin=document.getElementById('bulkMargin');
  const bulkUseOpenAI=document.getElementById('bulkUseOpenAI');
  
  // Mostrar nombre del archivo XLSX seleccionado
  if(bulkXlsx){
    bulkXlsx.addEventListener('change', ()=>{
      if(bulkXlsx.files && bulkXlsx.files.length>0){
        const fileName = bulkXlsx.files[0].name;
        xlsxFileName.textContent = '‚úì ' + fileName;
        xlsxFileName.style.color = 'var(--color-success)';
        if(xlsxLabel) xlsxLabel.textContent = '‚úì ' + (fileName.length > 20 ? fileName.substring(0,17)+'...' : fileName);
      } else {
        xlsxFileName.textContent = '';
        if(xlsxLabel) xlsxLabel.textContent = 'üìÑ Seleccionar XLSX';
      }
    });
  }
  
  // Mostrar nombre del archivo de precios seleccionado
  if(bulkPrices){
    bulkPrices.addEventListener('change', ()=>{
      if(bulkPrices.files && bulkPrices.files.length>0){
        const fileName = bulkPrices.files[0].name;
        pricesFileName.textContent = '‚úì ' + fileName;
        pricesFileName.style.color = 'var(--color-success)';
        if(pricesLabel) pricesLabel.textContent = '‚úì ' + (fileName.length > 20 ? fileName.substring(0,17)+'...' : fileName);
      } else {
        pricesFileName.textContent = '';
        if(pricesLabel) pricesLabel.textContent = 'üíµ Seleccionar Precios (.txt)';
      }
    });
  }
  
  async function runBulkUpload(){
    if(!bulkXlsx || !bulkXlsx.files || bulkXlsx.files.length===0){ alert('Seleccion√° el archivo XLSX de colores'); return; }
    if(!bulkPrices || !bulkPrices.files || bulkPrices.files.length===0){ 
      if(!confirm('No seleccionaste el archivo de precios. ¬øContinuar sin precios?')) return; 
    }
    if(!bulkFx || !bulkFx.value){ alert('Ingres√° el tipo de cambio USD‚ÜíARS'); return; }
    
    const useAI = bulkUseOpenAI && bulkUseOpenAI.checked;
    const prevTxt = bulkRun.textContent; 
    bulkRun.disabled = true; 
    bulkRun.textContent = useAI ? 'ü§ñ Normalizando con OpenAI...' : 'Importando...';
    
    const fd=new FormData();
    fd.append('file', bulkXlsx.files[0]);
    
    // Leer el archivo de precios y enviarlo como texto
    let pricesText = '';
    if(bulkPrices.files && bulkPrices.files.length > 0){
      try {
        pricesText = await bulkPrices.files[0].text();
      } catch(e) {
        console.error('Error leyendo archivo de precios:', e);
      }
    }
    
    fd.append('prices_text', pricesText);
    fd.append('fx_rate', bulkFx.value||'0');
    fd.append('default_margin_pct', bulkMargin.value||'0');
    fd.append('use_openai', useAI ? 'true' : 'false');
    
    const res=await fetch('/admin/import/csv',{method:'POST', headers:{Authorization:'Bearer '+token}, body:fd});
    
    bulkRun.disabled=false; 
    bulkRun.textContent=prevTxt;
    
    if(!res.ok){ 
      try {
        const errorData = await res.json();
        alert('‚ùå Error: ' + (errorData.message || 'Error importando archivo'));
      } catch(e) {
        alert('‚ùå Error importando archivo');
      }
      return; 
    }
    
    const out=await res.json();
    if(out.error){
      alert('‚ùå Error: ' + (out.message || out.error));
      return;
    }
    
    alert('‚úÖ Importaci√≥n OK!\n\n' +
      'Productos creados: '+(out.created_products||0)+'\n' +
      'Productos actualizados: '+(out.updated_products||0)+'\n' +
      (out.deprecated_products ? 'üóëÔ∏è Productos deprecados: '+out.deprecated_products+'\n' : '') +
      'Variantes creadas: '+(out.created_variants||0)+'\n' +
      'Variantes actualizadas: '+(out.updated_variants||0)+
      (out.unmatched ? '\n\n‚ö†Ô∏è Sin precio: '+out.unmatched : ''));
    savePageState(); // Guardar estado antes de recargar
    location.reload();
  }
  
  if(bulkRun){ 
    bulkRun.addEventListener('click', ()=>{ 
      if(!bulkXlsx.files || bulkXlsx.files.length===0){ 
        alert('‚ö†Ô∏è Por favor selecciona el archivo XLSX de colores primero');
        bulkXlsx.click(); 
      } else if(!bulkPrices.files || bulkPrices.files.length===0){
        alert('‚ö†Ô∏è Por favor selecciona el archivo de precios (.txt) primero');
        bulkPrices.click();
      } else { 
        // Mostrar confirmaci√≥n antes de importar
        const xlsxName = bulkXlsx.files[0].name;
        const pricesName = bulkPrices.files[0].name;
        const fx = bulkFx.value || '0';
        const margin = bulkMargin.value || '0';
        const useAI = bulkUseOpenAI && bulkUseOpenAI.checked;
        
        const confirmMsg = 
          'üì¶ CONFIRMAR IMPORTACI√ìN\n\n' +
          'üìÑ Archivo colores: ' + xlsxName + '\n' +
          'üíµ Archivo precios: ' + pricesName + '\n' +
          'üí± Tipo de cambio: $' + fx + '\n' +
          'üìà Margen: ' + margin + '%\n' +
          (useAI ? 'ü§ñ Usando OpenAI (lento)\n' : '‚ö° M√©todo tradicional (r√°pido)\n') +
          '\n¬øDeseas continuar con la importaci√≥n?';
        
        if(confirm(confirmMsg)){
          runBulkUpload(); 
        }
      } 
    }); 
  }
  
  // Removido: auto-run despu√©s de seleccionar archivos
  // Ahora el usuario debe hacer click en "Importar" manualmente

  btnReset.addEventListener('click', clear);
  btnDel.addEventListener('click', async ()=>{ const slug=fSlug.value.trim(); if(!slug) return; if(!confirm('Eliminar producto y sus im√°genes?')) return; const res=await fetch('/api/products/'+slug,{method:'DELETE', headers:{Authorization:'Bearer '+token}}); if(res.ok){ clear(); savePageState(); location.reload(); } else { alert('Error'); } });

  // Funci√≥n para guardar el estado de la p√°gina
  function savePageState(){
    const state = {
      searchTerm: searchInput ? searchInput.value : '',
      scrollPosition: window.scrollY || window.pageYOffset,
      timestamp: Date.now()
    };
    sessionStorage.setItem('adminProductsState', JSON.stringify(state));
  }
  
  // Funci√≥n para restaurar el estado de la p√°gina
  function restorePageState(){
    try{
      const stateStr = sessionStorage.getItem('adminProductsState');
      if(!stateStr) return;
      
      const state = JSON.parse(stateStr);
      
      // Si el estado tiene menos de 5 minutos, restaurarlo
      if(Date.now() - state.timestamp < 300000){
        // Restaurar b√∫squeda
        if(searchInput && state.searchTerm){
          searchInput.value = state.searchTerm;
          // Disparar evento input para aplicar el filtro
          searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Restaurar scroll despu√©s de que se aplique el filtro
        if(state.scrollPosition){
          setTimeout(() => {
            window.scrollTo(0, state.scrollPosition);
          }, 100);
        }
      }
      
      // Limpiar el estado despu√©s de restaurarlo
      sessionStorage.removeItem('adminProductsState');
    } catch(e){
      console.error('Error restaurando estado:', e);
      sessionStorage.removeItem('adminProductsState');
    }
  }
  
  // B√∫squeda de productos en la tabla
  let filterNoImagesActive = false;
  const filterNoImagesBtn = document.getElementById('filterNoImages');
  
  function applyFilters(){
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const rows = tbl ? tbl.querySelectorAll('tbody tr') : [];
    let visibleCount = 0;
    
    rows.forEach(row => {
      const name = (row.cells[0]?.textContent || '').toLowerCase();
      const slug = (row.cells[1]?.textContent || '').toLowerCase();
      const brand = (row.cells[2]?.textContent || '').toLowerCase();
      const model = (row.cells[3]?.textContent || '').toLowerCase();
      const imagesCount = (row.cells[9]?.textContent || '').trim(); // Columna "Imgs" (√≠ndice 9)
      
      let matchesSearch = !searchTerm || name.includes(searchTerm) || slug.includes(searchTerm) || brand.includes(searchTerm) || model.includes(searchTerm);
      let matchesImageFilter = !filterNoImagesActive || imagesCount === '0';
      
      const matches = matchesSearch && matchesImageFilter;
      row.style.display = matches ? '' : 'none';
      if(matches) visibleCount++;
    });
    
    // Actualizar contador en el t√≠tulo
    const titleEl = document.querySelector('div > h2');
    if(titleEl && titleEl.textContent.includes('Listado')){
      const totalMatch = titleEl.textContent.match(/\((\d+)\)/);
      const total = totalMatch ? parseInt(totalMatch[1]) : rows.length;
      if(searchTerm || filterNoImagesActive){
        titleEl.textContent = `Listado (${visibleCount}${visibleCount !== total ? ' de ' + total : ''})`;
      } else {
        titleEl.textContent = `Listado (${total})`;
      }
    }
    
    // Actualizar estado del bot√≥n de filtro
    if(filterNoImagesBtn){
      if(filterNoImagesActive){
        filterNoImagesBtn.style.background = 'var(--color-brand)';
        filterNoImagesBtn.style.color = '#fff';
        filterNoImagesBtn.style.borderColor = 'var(--color-brand)';
      } else {
        filterNoImagesBtn.style.background = 'var(--panel)';
        filterNoImagesBtn.style.color = 'var(--color-text)';
        filterNoImagesBtn.style.borderColor = 'var(--color-border)';
      }
    }
  }
  
  if(searchInput && tbl){
    searchInput.addEventListener('input', applyFilters);
  }
  
  // Filtro por productos sin im√°genes
  if(filterNoImagesBtn && tbl){
    filterNoImagesBtn.addEventListener('click', () => {
      filterNoImagesActive = !filterNoImagesActive;
      applyFilters();
    });
  }
  
  // Restaurar estado al cargar la p√°gina
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      restorePageState();
    }, 200);
  });

  // Drag & drop images preview
  function refreshPreview(){
    if(!preview || !dzCount) return;
    preview.innerHTML='';
    const files=Array.from(imagesInput.files||[]);
    const count = files.length;
    dzCount.textContent = count + (count === 0 ? ' archivos seleccionados' : (count === 1 ? ' archivo seleccionado' : ' archivos seleccionados'));
    
    if(count > 0){
      dropZone.style.borderColor = 'var(--color-success)';
      dropZone.style.background = 'color-mix(in srgb, var(--color-success) 5%, var(--panel-alt))';
    } else {
      dropZone.style.borderColor = 'var(--color-border)';
      dropZone.style.background = 'var(--panel-alt)';
    }
    
    files.slice(0,6).forEach(f=>{
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'position:relative;width:70px;height:70px;border-radius:8px;overflow:hidden;border:2px solid var(--color-success)';
      
      const r=new FileReader();
      r.onload=ev=>{ 
        const img=document.createElement('img'); 
        img.src=ev.target.result; 
        img.alt=f.name; 
        img.style.cssText='width:100%;height:100%;object-fit:cover;display:block';
        wrapper.appendChild(img);
      };
      r.readAsDataURL(f);
      preview.appendChild(wrapper);
    });
    
    if(count > 6){
      const more = document.createElement('div');
      more.style.cssText = 'width:70px;height:70px;border-radius:8px;background:var(--panel);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--muted)';
      more.textContent = '+' + (count - 6);
      preview.appendChild(more);
    }
  }
  
  if(imagesInput) imagesInput.addEventListener('change', refreshPreview);
  if(fGross) fGross.addEventListener('input', recomputePrice);
  if(fMargin) fMargin.addEventListener('input', recomputePrice);
  
  // Mejorar dropzone con efectos visuales
  if(dropZone){
    ['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{
      e.preventDefault(); 
      dropZone.style.borderColor='var(--color-brand)';
      dropZone.style.background='color-mix(in srgb, var(--color-brand) 8%, var(--panel-alt))';
      dropZone.style.transform='scale(1.02)';
    }));
    
    ['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{
      e.preventDefault(); 
      dropZone.style.borderColor='var(--color-border)';
      dropZone.style.background='var(--panel-alt)';
      dropZone.style.transform='scale(1)';
    }));
    
    dropZone.addEventListener('drop', e=>{ 
      const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')); 
      if(files.length){ 
        const dt=new DataTransfer(); 
        files.forEach(f=>dt.items.add(f)); 
        imagesInput.files=dt.files; 
        refreshPreview(); 
      }
    });
    
    // Click en el dropzone para abrir selector
    dropZone.addEventListener('click', (e)=>{
      if(e.target !== imagesInput && !e.target.closest('.dz-preview')){
        imagesInput.click();
      }
    });
  }

})();
</script>

<!-- Mover los modales fuera del main para que tengan z-index correcto -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const imageModal = document.getElementById('imageSearchModal');
    if (imageModal && imageModal.parentNode !== document.body) {
      document.body.appendChild(imageModal);
    }
    const workflowModal = document.getElementById('workflowModal');
    if (workflowModal && workflowModal.parentNode !== document.body) {
      document.body.appendChild(workflowModal);
    }
    
    // Verificar que los elementos del modal existan
    console.log('Modal workflow:', workflowModal ? 'encontrado' : 'NO encontrado');
    if (workflowModal) {
      console.log('Elementos del modal:', {
        loading: !!document.getElementById('workflowLoading'),
        results: !!document.getElementById('workflowResults'),
        error: !!document.getElementById('workflowError'),
        productName: !!document.getElementById('workflowProductName'),
        imageGrid: !!document.getElementById('workflowImageGrid'),
        addAllBtn: !!document.getElementById('workflowAddAllBtn'),
        cancelBtn: !!document.getElementById('workflowCancelBtn'),
        closeBtn: !!document.getElementById('closeWorkflowModal')
      });
    }
  });
</script>

{{template "layout_end" .}}
{{end}}

