{{define "products.html"}}
{{template "layout_start" .}}
<div style="margin-bottom:24px">
  <h1 style="font-size:36px;font-weight:800;margin:0 0 8px;color:var(--color-text);letter-spacing:-1px;line-height:1.2">Celulares y accesorios</h1>
  <p id="productsCounter" style="font-size:15px;color:var(--color-muted);margin:0;font-weight:500">
    Mostrando <span id="loadedCount">{{len .Products}}</span> de <span id="totalCount">{{.Total}}</span> productos
  </p>
</div>

<!-- Botones de Filtro y Ordenamiento -->
<div class="mobile-actions">
  <button type="button" class="btn-filter {{if or .Query .Category}}has-active{{end}}" aria-expanded="false" aria-label="Abrir filtros">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px">
      <line x1="4" y1="6" x2="20" y2="6"></line>
      <line x1="4" y1="12" x2="20" y2="12"></line>
      <line x1="4" y1="18" x2="20" y2="18"></line>
      <circle cx="8" cy="6" r="2"></circle>
      <circle cx="16" cy="12" r="2"></circle>
      <circle cx="12" cy="18" r="2"></circle>
    </svg>
    <span>Filtrar</span>
    {{if or .Query .Category}}
    <span class="filter-badge">
      {{if and .Query .Category}}2{{else}}1{{end}}
    </span>
    {{end}}
  </button>
  <button type="button" class="btn-sort {{if .Sort}}has-active{{end}}" aria-expanded="false" aria-label="Ordenar productos">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px">
      <path d="M3 6h18M3 12h12M3 18h6"></path>
      <path d="M16 18l3-3 3 3"></path>
      <path d="M19 15v6"></path>
    </svg>
    <span>Ordenar</span>
    {{if .Sort}}
    <span class="filter-badge">1</span>
    {{end}}
  </button>
</div>

<!-- Filtros activos (chips) -->
{{if or .Query .Category .Sort}}
<div class="active-chips">
  {{if .Query}}
  <span class="chip" data-clear="q">
    üîç B√∫squeda: "{{.Query}}"
    <button type="button" aria-label="Quitar filtro de b√∫squeda">√ó</button>
  </span>
  {{end}}
  {{if .Category}}
  <span class="chip" data-clear="category">
    üì± {{.Category}}
    <button type="button" aria-label="Quitar filtro de categor√≠a">√ó</button>
  </span>
  {{end}}
  {{if .Sort}}
  <span class="chip" data-clear="sort">
    {{if eq .Sort "newest"}}‚≠ê Novedades{{end}}
    {{if eq .Sort "price_asc"}}üí∞ Menor precio{{end}}
    {{if eq .Sort "price_desc"}}üí∞ Mayor precio{{end}}
    {{if eq .Sort "name"}}üî§ A-Z{{end}}
    <button type="button" aria-label="Quitar ordenamiento">√ó</button>
  </span>
  {{end}}
</div>
{{end}}

<!-- Backdrop para los sheets -->
<div id="filterSheetBackdrop" class="sheet-backdrop" hidden></div>
<div id="sortSheetBackdrop" class="sheet-backdrop" hidden></div>

<!-- Sheet de Filtros -->
<div id="filterSheet" class="sheet" hidden aria-hidden="true">
  <header class="sheet-head">
    <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--color-text)">Filtrar productos</h2>
    <button type="button" class="sheet-close" aria-label="Cerrar" style="background:var(--panel-alt);border:1px solid var(--color-border);color:var(--color-text);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center">√ó</button>
  </header>
  <form id="filtersForm" method="get" action="/products" style="display:flex;flex-direction:column;gap:16px;margin-top:16px">
    <div class="field" style="display:flex;flex-direction:column;gap:8px">
      <label for="q" style="font-size:14px;font-weight:600;color:var(--color-text)">Buscar por nombre</label>
      <input id="q" type="text" name="q" value="{{.Query}}" placeholder="Ej: Samsung Galaxy..." style="width:100%;padding:12px;border:1px solid var(--color-border);border-radius:10px;background:var(--panel-alt);color:var(--color-text);font-size:14px" />
    </div>
    <div class="field" style="display:flex;flex-direction:column;gap:8px">
      <label for="category" style="font-size:14px;font-weight:600;color:var(--color-text)">Categor√≠a</label>
      <select id="category" name="category" style="width:100%;padding:12px;border:1px solid var(--color-border);border-radius:10px;background:var(--panel-alt);color:var(--color-text);font-size:14px">
        <option value="">Todas las categor√≠as</option>
        {{range .Categories}}
          <option value="{{.}}" {{if eq $.Category .}}selected{{end}}>{{.}}</option>
        {{end}}
      </select>
    </div>
    <input type="hidden" id="sortInput" name="sort" value="{{.Sort}}">
    <div style="display:flex;gap:12px;margin-top:8px">
      <button type="submit" class="btn-primary" style="flex:1;padding:14px;font-size:15px;font-weight:600">Aplicar filtros</button>
      <a href="/products" class="btn-secondary" style="flex:1;padding:14px;font-size:15px;font-weight:600;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center">Limpiar</a>
    </div>
  </form>
</div>

<!-- Sheet de Ordenamiento -->
<div id="sortSheet" class="sheet" hidden aria-hidden="true">
  <header class="sheet-head">
    <h2 style="margin:0;font-size:18px;font-weight:600;color:var(--color-text)">Ordenar por</h2>
    <button type="button" class="sheet-close" aria-label="Cerrar" style="background:var(--panel-alt);border:1px solid var(--color-border);color:var(--color-text);width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center">√ó</button>
  </header>
  <ul class="sort-list">
    <li><button type="button" data-sort="" aria-pressed="{{not .Sort}}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span>Relevancia</span>
        {{if not .Sort}}<span style="color:var(--color-brand)">‚úì</span>{{end}}
      </div>
    </button></li>
    <li><button type="button" data-sort="newest" aria-pressed="{{eq .Sort "newest"}}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span>Novedades</span>
        {{if eq .Sort "newest"}}<span style="color:var(--color-brand)">‚úì</span>{{end}}
      </div>
    </button></li>
    <li><button type="button" data-sort="price_asc" aria-pressed="{{eq .Sort "price_asc"}}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span>üí∞ Precio: menor a mayor</span>
        {{if eq .Sort "price_asc"}}<span style="color:var(--color-brand)">‚úì</span>{{end}}
      </div>
    </button></li>
    <li><button type="button" data-sort="price_desc" aria-pressed="{{eq .Sort "price_desc"}}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span>üí∞ Precio: mayor a menor</span>
        {{if eq .Sort "price_desc"}}<span style="color:var(--color-brand)">‚úì</span>{{end}}
      </div>
    </button></li>
    <li><button type="button" data-sort="name" aria-pressed="{{eq .Sort "name"}}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span>üî§ Nombre A‚ÄìZ</span>
        {{if eq .Sort "name"}}<span style="color:var(--color-brand)">‚úì</span>{{end}}
      </div>
    </button></li>
  </ul>
</div>

<div class="cards cards--products" data-initial-page="{{.Page}}" data-total-pages="{{.Pages}}" data-total-count="{{.Total}}">
  {{range $idx, $p := .Products}}
  <div class="card">
    <div class="card-media">
      {{if $p.Images}}
        <img src="{{img (index $p.Images 0).URL}}"
             alt="{{if (index $p.Images 0).Alt}}{{(index $p.Images 0).Alt}}{{else}}{{$p.Name}}{{end}}"
             loading="lazy" decoding="async" {{if eq $idx 0}}fetchpriority="high"{{end}}
             srcset="{{img (index $p.Images 0).URL}} 300w, {{imgw (index $p.Images 0).URL 480}} 480w, {{imgw (index $p.Images 0).URL 640}} 640w"
             sizes="(max-width:480px) 92vw, (max-width:768px) 44vw, 300px"
             class="card-img" />
      {{else}}
        <div class="placeholder">IMG</div>
      {{end}}
    </div>
    <div class="card-body">
      <div class="badges">
        <span class="badge green">En stock</span>
        <span class="badge gray">Env√≠o en el d√≠a</span>
      </div>
      <h3 class="card-title"><a href="/product/{{$p.Slug}}">{{$p.Name}}</a></h3>
      <div class="card-meta">{{$p.Category}}</div>
      <div class="price-row">
        <span class="price">{{formatPrice $p.BasePrice}}</span>
      </div>
      <div class="actions">
        <a href="/product/{{$p.Slug}}" class="btn-primary btn-full" style="text-align:center;text-decoration:none">Ver detalles</a>
      </div>
    </div>
  </div>
  {{end}}
  {{if not .Products}}
    <p class="empty">No se encontraron productos.</p>
  {{end}}
</div>

<!-- Elemento centinela para el IntersectionObserver (siempre visible) -->
<div id="scrollSentinel" style="height:1px;width:100%;margin:0"></div>

<div id="loadingIndicator" style="text-align:center;margin:24px 0;display:none">
  <div style="display:inline-block;padding:12px 24px;color:var(--color-muted);font-size:15px">
    Cargando m√°s productos...
  </div>
</div>

<div id="endMessage" style="text-align:center;margin:24px 0;display:none">
  <div style="color:var(--color-muted);font-size:15px">
    No hay m√°s productos
  </div>
</div>

<!-- JS movido a /public/assets/app.js -->
{{template "layout_end" .}}
{{end}}
