{{define "products.html"}}
{{template "layout_start" .}}
<div style="margin-bottom:32px">
  <h1 style="font-size:36px;font-weight:800;margin:0 0 8px;color:var(--color-text);letter-spacing:-1px;line-height:1.2">Celulares y accesorios</h1>
  <p id="productsCounter" style="font-size:15px;color:var(--color-muted);margin:0;font-weight:500">
    Mostrando <span id="loadedCount">{{len .Products}}</span> de <span id="totalCount">{{.Total}}</span> productos
  </p>
</div>

<aside id="filterDrawer" class="drawer" hidden aria-hidden="true">
  <form id="filtersForm" method="get" action="/products" class="drawer-panel" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
    <header class="drawer-head">
      <h2 id="drawerTitle">Filtrar</h2>
      <button type="button" class="drawer-close" aria-label="Cerrar">×</button>
    </header>

    <div class="drawer-body">
      <div class="field">
        <label for="q">Buscar por nombre</label>
        <input id="q" type="text" name="q" value="{{.Query}}" placeholder="Buscar..." />
      </div>
      <div class="field">
        <label for="category">Categoría</label>
        <select id="category" name="category">
          <option value="">Todas las categorías</option>
          {{range .Categories}}
            <option value="{{.}}" {{if eq $.Category .}}selected{{end}}>{{.}}</option>
          {{end}}
        </select>
      </div>
      <input type="hidden" id="sortInput" name="sort" value="{{.Sort}}">
    </div>

    <footer class="drawer-foot">
      <button type="submit" class="btn-primary">Aplicar</button>
      <a class="link-reset" href="/products">Limpiar</a>
    </footer>
  </form>
</aside>

<div id="sortSheet" class="sheet" hidden aria-hidden="true">
  <header class="sheet-head">
    <h2>Ordenar</h2>
    <button type="button" class="sheet-close" aria-label="Cerrar">×</button>
  </header>
  <ul class="sort-list">
    <li><button type="button" data-sort="newest" aria-pressed="{{eq .Sort "newest"}}">Novedades</button></li>
    <li><button type="button" data-sort="price_asc" aria-pressed="{{eq .Sort "price_asc"}}">Precio: menor a mayor</button></li>
    <li><button type="button" data-sort="price_desc" aria-pressed="{{eq .Sort "price_desc"}}">Precio: mayor a menor</button></li>
    <li><button type="button" data-sort="name" aria-pressed="{{eq .Sort "name"}}">Nombre A–Z</button></li>
  </ul>
</div>

<div class="cards cards--products" data-initial-page="{{.Page}}" data-total-pages="{{.Pages}}" data-total-count="{{.Total}}">
  {{range $idx, $p := .Products}}
  <div class="card">
    <div class="card-media ar-1-1">
      {{if $p.Images}}
        <img src="{{img (index $p.Images 0).URL}}"
             alt="{{if (index $p.Images 0).Alt}}{{(index $p.Images 0).Alt}}{{else}}{{$p.Name}}{{end}}"
             loading="lazy" decoding="async" {{if eq $idx 0}}fetchpriority="high"{{end}}
             srcset="{{img (index $p.Images 0).URL}} 300w, {{imgw (index $p.Images 0).URL 480}} 480w, {{imgw (index $p.Images 0).URL 640}} 640w"
             sizes="(max-width:480px) 92vw, (max-width:768px) 44vw, 300px"
             class="card-img" />
      {{else}}
        <div class="placeholder">IMG</div>
      {{end}}
    </div>
    <div class="card-body">
      <div class="badges">
        <span class="badge green">En stock</span>
        <span class="badge gray">Envío en el día</span>
      </div>
      <h3 class="card-title"><a href="/product/{{$p.Slug}}">{{$p.Name}}</a></h3>
      <div class="card-meta">{{$p.Category}}</div>
      <div class="price-row">
        <span class="price">{{ars $p.BasePrice}}</span>
      </div>
      <div class="actions">
        <a href="/product/{{$p.Slug}}" class="btn-primary btn-full" style="text-align:center;text-decoration:none">Ver detalles</a>
      </div>
    </div>
  </div>
  {{end}}
  {{if not .Products}}
    <p class="empty">No se encontraron productos.</p>
  {{end}}
</div>

<!-- Elemento centinela para el IntersectionObserver (siempre visible) -->
<div id="scrollSentinel" style="height:1px;width:100%;margin:0"></div>

<div id="loadingIndicator" style="text-align:center;margin:24px 0;display:none">
  <div style="display:inline-block;padding:12px 24px;color:var(--color-muted);font-size:15px">
    Cargando más productos...
  </div>
</div>

<div id="endMessage" style="text-align:center;margin:24px 0;display:none">
  <div style="color:var(--color-muted);font-size:15px">
    No hay más productos
  </div>
</div>

<!-- JS movido a /public/assets/app.js -->
{{template "layout_end" .}}
{{end}}
